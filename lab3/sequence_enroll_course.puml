@startuml Enroll_in_Course_Sequence

title Sequence Diagram: Enroll in Course

actor Student
participant "Web UI" as UI
participant "CourseController" as Controller
participant "EnrollmentService" as Service
participant "PrerequisiteValidator" as Validator
participant "EnrollmentRepository" as EnrollRepo
participant "TuitionCalculator" as Calculator
participant "PaymentGateway" as Payment
database "Database" as DB
participant "EmailService" as Email

== Enrollment Request ==
Student -> UI: selectCourse(courseId)
activate UI

UI -> Controller: enrollInCourse(studentId, courseId)
activate Controller

Controller -> Service: processEnrollment(studentId, courseId)
activate Service

== Check Prerequisites ==
Service -> Validator: validatePrerequisites(studentId, courseId)
activate Validator

Validator -> DB: getStudentTranscript(studentId)
activate DB
DB --> Validator: completedCourses[]
deactivate DB

Validator -> DB: getCoursePrerequisites(courseId)
activate DB
DB --> Validator: prerequisites[]
deactivate DB

alt Prerequisites Not Met
    Validator --> Service: PrerequisiteException("Missing: Course XYZ")
    Service --> Controller: error
    Controller --> UI: showError("Prerequisites not met")
    UI --> Student: displayError()
else Prerequisites Met
    Validator --> Service: valid
    deactivate Validator

    == Verify Enrollment Status ==
    Service -> EnrollRepo: checkEnrollmentStatus(studentId)
    activate EnrollRepo

    EnrollRepo -> DB: query enrollment
    activate DB
    DB --> EnrollRepo: currentCourses[]
    deactivate DB

    alt Schedule Conflict
        EnrollRepo --> Service: ConflictException("Time conflict")
        Service --> Controller: error
        Controller --> UI: showError("Schedule conflict")
        UI --> Student: displayError()
    else Course Full
        EnrollRepo --> Service: CapacityException("Course full")
        Service --> Controller: error
        Controller --> UI: showError("Course is full")
        UI --> Student: displayError()
    else Enrollment Allowed
        EnrollRepo --> Service: canEnroll
        deactivate EnrollRepo

        == Calculate Tuition ==
        Service -> Calculator: calculateTuition(courseId)
        activate Calculator

        Calculator -> DB: getCourseCredits(courseId)
        activate DB
        DB --> Calculator: credits
        deactivate DB

        Calculator --> Service: tuitionAmount
        deactivate Calculator

        == Process Payment ==
        Service -> Payment: processPayment(studentId, amount)
        activate Payment

        Payment -> Payment: validatePaymentMethod()

        alt Payment Failed
            Payment --> Service: PaymentFailedException()
            Service --> Controller: error
            Controller --> UI: showError("Payment failed")
            UI --> Student: displayError()
        else Payment Success
            Payment --> Service: paymentConfirmation
            deactivate Payment

            == Create Enrollment ==
            Service -> EnrollRepo: createEnrollment(studentId, courseId)
            activate EnrollRepo

            EnrollRepo -> DB: INSERT enrollment
            activate DB
            DB --> EnrollRepo: enrollmentId
            deactivate DB

            EnrollRepo --> Service: enrollment
            deactivate EnrollRepo

            == Send Notification ==
            Service -> Email: sendEnrollmentConfirmation(studentId, courseId)
            activate Email

            Email -> Email: composeEmail()
            Email -> Email: sendEmail()

            Email --> Service: sent
            deactivate Email

            Service --> Controller: enrollmentSuccess
            deactivate Service

            Controller --> UI: success(enrollmentDetails)
            deactivate Controller

            UI --> Student: showConfirmation("Enrolled successfully")
            deactivate UI
        end
    end
end

@enduml